name: Build Optimized Go Binary

on:
  workflow_dispatch:

jobs:
  build:
    name: Build (Linux/AMD64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go 1.25
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.5'
          cache: false # Automatically caches Go modules and build artifacts

      - name: Build Optimized Binary
        env:
          CGO_ENABLED: 0   # Static build (no libc dependency)
          GOOS: linux
          GOARCH: amd64
          GOAMD64: v3      # Target AVX2 (Haswell+) for better crypto performance
          GODEBUG: thp=1,netdns=go
          GOEXPERIMENT: greenteagc
        run: |
          go build \
            -trimpath \
            -tags "netgo osusergo" \
            -ldflags="-s -w" -pgo=auto \
            -o dnscrypt-proxy \
            ./dnscrypt-proxy

      - name: Upload Artifact
        uses: actions/upload-artifact@4
        with:
          name: dnscrypt-proxy-linux-amd64
          path: dnscrypt-proxy
          if-no-files-found: error
          retention-days: 5
